<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Working with Raster Data • ebirdst</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Working with Raster Data">
<meta property="og:description" content="ebirdst">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ebirdst</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.2021.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/ebirdst.html">Get Started</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ebirdst.html">Introduction to eBird Status &amp; Trends Data</a>
    </li>
    <li>
      <a href="../articles/rasters.html">Working with Raster Data</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Function Reference</a>
</li>
<li>
  <a href="../articles/product-changelog.html#2020-changelog">Changelog</a>
</li>
<li>
  <a href="../news/index.html">Version History</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/CornellLabofOrnithology/ebirdst/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Working with Raster Data</h1>
                        <h4 data-toc-skip class="author">Matt
Strimas-Mackey, Tom Auer, Daniel Fink</h4>
            
            <h4 data-toc-skip class="date">2023-01-10</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/CornellLabofOrnithology/ebirdst/blob/HEAD/vignettes/rasters.Rmd" class="external-link"><code>vignettes/rasters.Rmd</code></a></small>
      <div class="hidden name"><code>rasters.Rmd</code></div>

    </div>

    
    
<style type="text/css">
.table {
    width: 50%;
}
</style>
<div class="section level2">
<h2 id="outline">Outline<a class="anchor" aria-label="anchor" href="#outline"></a>
</h2>
<ol style="list-style-type: decimal">
<li><a href="#load">Loading raster data</a></li>
<li><a href="#map">Mapping relative abundance</a></li>
<li><a href="#trajectories">Extracting trajectories with
uncertainty</a></li>
<li><a href="#stats">Regional statistics</a></li>
</ol>
</div>
<div class="section level2">
<h2 id="load">Loading raster data<a class="anchor" aria-label="anchor" href="#load"></a>
</h2>
<p>As covered in the <a href="https://cornelllabofornithology.github.io/ebirdst/articles/ebirdst.html">Get
Started vignette</a>, the function <code><a href="../reference/load_raster.html">load_raster()</a></code> loads
raster data products in R as <code>SpatRaster</code> objects, which we
can work with using the <code>terra</code> package. Let’s start by
loading the seasonal relative abundance raster for the example
Yellow-bellied Sapsucker data. We’ll work with the low resolution data
in this vignette to ensure fast processing times.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/CornellLabofOrnithology/ebirdst" class="external-link">ebirdst</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/terra/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ropenscilabs/rnaturalearth" class="external-link">rnaturalearth</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">geodata</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dnychka/fieldsRPackage" class="external-link">fields</a></span><span class="op">)</span></span>
<span><span class="va">extract</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/terra/man/extract.html" class="external-link">extract</a></span></span>
<span></span>
<span><span class="co"># download the example yellow-bellied sapsucker data</span></span>
<span><span class="co"># this simplified dataset doesn't require an access key</span></span>
<span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ebirdst_download.html">ebirdst_download</a></span><span class="op">(</span><span class="st">"example_data"</span><span class="op">)</span></span>
<span><span class="co"># alternatively, you can use the following to get the data path</span></span>
<span><span class="co"># if the data package has already been downloaded</span></span>
<span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_species_path.html">get_species_path</a></span><span class="op">(</span><span class="st">"example_data"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># load seasonal mean relative abundance at low res</span></span>
<span><span class="va">abd_seasonal</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_raster.html">load_raster</a></span><span class="op">(</span><span class="va">path</span>, </span>
<span>                           product <span class="op">=</span> <span class="st">"abundance"</span>, </span>
<span>                           period <span class="op">=</span> <span class="st">"seasonal"</span>,</span>
<span>                           metric <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>                           resolution <span class="op">=</span> <span class="st">"lr"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># get the seasons corresponding to each layer</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">abd_seasonal</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "breeding"               "nonbreeding"            "prebreeding_migration" </span></span>
<span><span class="co">#&gt; [4] "postbreeding_migration"</span></span>
<span></span>
<span><span class="co"># extract just the breeding season relative abundance</span></span>
<span><span class="va">abd_breeding</span> <span class="op">&lt;-</span> <span class="va">abd_seasonal</span><span class="op">[[</span><span class="st">"breeding"</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p>We can get the dates and quality scores associated with each of these
seasons by filtering the <code>ebirdst_runs</code> data frame.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ebirdst_runs</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># note that the example data are for yellow-bellied sapsucker</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">common_name</span> <span class="op">==</span> <span class="st">"Yellow-bellied Sapsucker"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 1</span></span>
<span><span class="co">#&gt; Columns: 23</span></span>
<span><span class="co">#&gt; $ species_code                         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "yebsap"</span></span>
<span><span class="co">#&gt; $ scientific_name                      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "Sphyrapicus varius"</span></span>
<span><span class="co">#&gt; $ common_name                          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "Yellow-bellied Sapsucker"</span></span>
<span><span class="co">#&gt; $ resident                             <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> FALSE</span></span>
<span><span class="co">#&gt; $ breeding_quality                     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 3</span></span>
<span><span class="co">#&gt; $ breeding_range_modeled               <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> TRUE</span></span>
<span><span class="co">#&gt; $ breeding_start                       <span style="color: #949494; font-style: italic;">&lt;date&gt;</span> 2021-05-24</span></span>
<span><span class="co">#&gt; $ breeding_end                         <span style="color: #949494; font-style: italic;">&lt;date&gt;</span> 2021-08-17</span></span>
<span><span class="co">#&gt; $ nonbreeding_quality                  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 3</span></span>
<span><span class="co">#&gt; $ nonbreeding_range_modeled            <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> TRUE</span></span>
<span><span class="co">#&gt; $ nonbreeding_start                    <span style="color: #949494; font-style: italic;">&lt;date&gt;</span> 2021-11-23</span></span>
<span><span class="co">#&gt; $ nonbreeding_end                      <span style="color: #949494; font-style: italic;">&lt;date&gt;</span> 2021-03-08</span></span>
<span><span class="co">#&gt; $ postbreeding_migration_quality       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 3</span></span>
<span><span class="co">#&gt; $ postbreeding_migration_range_modeled <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> TRUE</span></span>
<span><span class="co">#&gt; $ postbreeding_migration_start         <span style="color: #949494; font-style: italic;">&lt;date&gt;</span> 2021-08-24</span></span>
<span><span class="co">#&gt; $ postbreeding_migration_end           <span style="color: #949494; font-style: italic;">&lt;date&gt;</span> 2021-11-16</span></span>
<span><span class="co">#&gt; $ prebreeding_migration_quality        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 3</span></span>
<span><span class="co">#&gt; $ prebreeding_migration_range_modeled  <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span> TRUE</span></span>
<span><span class="co">#&gt; $ prebreeding_migration_start          <span style="color: #949494; font-style: italic;">&lt;date&gt;</span> 2021-03-15</span></span>
<span><span class="co">#&gt; $ prebreeding_migration_end            <span style="color: #949494; font-style: italic;">&lt;date&gt;</span> 2021-05-17</span></span>
<span><span class="co">#&gt; $ resident_quality                     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 3</span></span>
<span><span class="co">#&gt; $ resident_start                       <span style="color: #949494; font-style: italic;">&lt;date&gt;</span> NA</span></span>
<span><span class="co">#&gt; $ resident_end                         <span style="color: #949494; font-style: italic;">&lt;date&gt;</span> NA</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="map">Mapping relative abundance<a class="anchor" aria-label="anchor" href="#map"></a>
</h2>
<p>In this section, we’ll demonstrate how to make a simple map of
breeding season relative abundance. However, note that to make
high-quality, publication-ready maps typically requires extra work. It
many cases, it may be worthwhile designing maps in a traditional GIS
environment such as QGIS or ArcGIS.</p>
<p>The simplest way to map the seasonal relative abundance data is to
use the built in <code><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot()</a></code> function from the
<code>raster</code> package.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">abd_breeding</span>, axes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="rasters_files/figure-html/map_simple-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>Clearly this approach doesn’t work out of the box! There are a wide
variety of issues that we’ll tackle one at a time.</p>
<div class="section level3">
<h3 id="extent">Extent<a class="anchor" aria-label="anchor" href="#extent"></a>
</h3>
<p>All raster data downloaded through this package are defined over the
same global grid, regardless of the range of the individual species. The
example data only has non-zero abundance within the state of Michigan,
which is barely visible on the above global map. We need to define an
extent for our map. There are a variety of ways to do this, but we’ll
use the R package <code>rnaturalearth</code> to access a polygon
boundary for Michigan, which we’ll then use to crop the raster.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># boundary polygon for michigan</span></span>
<span><span class="va">mi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rnaturalearth/man/ne_states.html" class="external-link">ne_states</a></span><span class="op">(</span>iso_a2 <span class="op">=</span> <span class="st">"US"</span>, returnclass <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">postal</span> <span class="op">==</span> <span class="st">"MI"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># project to same coordinate reference system as the raster data</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">abd_seasonal</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># crop data to michigan</span></span>
<span><span class="va">abd_breeding_mi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">abd_breeding</span>, <span class="va">mi</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># map the cropped data</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">abd_breeding_mi</span>, axes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="rasters_files/figure-html/map_extent-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="projection">Projection<a class="anchor" aria-label="anchor" href="#projection"></a>
</h3>
<p>The raster data are all provided in the same equal area sinusoidal
projection as NASA MODIS data. While this projection is suitable for
analysis, it is not ideal for mapping since it introduces significant
distortion. Instead, as part of the Status and Trends workflow, custom
species-specific projections are provided that are optimized for the
region that the species occurs within. We can access the projection for
Yellow-bellied Sapsucker with <code><a href="../reference/load_fac_map_parameters.html">load_fac_map_parameters()</a></code>,
then transform the raster data to this custom projection.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load the mapping parameters</span></span>
<span><span class="va">fac_parameters</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_fac_map_parameters.html">load_fac_map_parameters</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span></span>
<span><span class="va">crs</span> <span class="op">&lt;-</span> <span class="va">fac_parameters</span><span class="op">$</span><span class="va">custom_projection</span></span>
<span></span>
<span><span class="co"># transform to the custom projection using nearest neighbor resampling</span></span>
<span><span class="va">abd_projected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/project.html" class="external-link">project</a></span><span class="op">(</span><span class="va">abd_breeding_mi</span>, <span class="va">crs</span>, method <span class="op">=</span> <span class="st">"near"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># map the cropped and projected data</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">abd_projected</span>, axes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="rasters_files/figure-html/map_projection-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="abundance-bins">Abundance bins<a class="anchor" aria-label="anchor" href="#abundance-bins"></a>
</h3>
<p>The relative abundance data are not uniformly distributed, which can
lead to challenges distinguishing areas of differing levels of
abundance. To address this, we’ll use a quantile bins for the map, where
each color in the legend corresponds to an equal number of cells in the
raster. We’ll define these bins excluding zeros, then assign a separate
color to the zeros. We can also use the function
<code><a href="../reference/abundance_palette.html">abundance_palette()</a></code> to get the same set of colors we use in
the legends on the eBird Status and Trends website.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># quantiles of non-zero values</span></span>
<span><span class="va">v</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/values.html" class="external-link">values</a></span><span class="op">(</span><span class="va">abd_projected</span><span class="op">)</span></span>
<span><span class="va">v</span> <span class="op">&lt;-</span> <span class="va">v</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">&amp;</span> <span class="va">v</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span></span>
<span><span class="va">bins</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">v</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, by <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># add a bin for 0</span></span>
<span><span class="va">bins</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">bins</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># status and trends palette</span></span>
<span><span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/abundance_palette.html">abundance_palette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">bins</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co"># add a color for zero</span></span>
<span><span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#e6e6e6"</span>, <span class="va">pal</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># map using the quantile bins</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">abd_projected</span>, breaks <span class="op">=</span> <span class="va">bins</span>, col <span class="op">=</span> <span class="va">pal</span>, axes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="rasters_files/figure-html/map_bins-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="basemap">Basemap<a class="anchor" aria-label="anchor" href="#basemap"></a>
</h3>
<p>Finally, we’ll add state and country boundaries to provide some
context. The R package <code>rnaturalearth</code> is an excellent source
of attribution free contextual GIS data.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># natural earth boundaries</span></span>
<span><span class="va">countries</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rnaturalearth/man/ne_countries.html" class="external-link">ne_countries</a></span><span class="op">(</span>returnclass <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">crs</span><span class="op">)</span></span>
<span><span class="va">states</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rnaturalearth/man/ne_states.html" class="external-link">ne_states</a></span><span class="op">(</span>iso_a2 <span class="op">=</span> <span class="st">"US"</span>, returnclass <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">crs</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># define the map extent with the michigan polygon</span></span>
<span><span class="va">mi_ext</span> <span class="op">&lt;-</span> <span class="va">mi</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">crs</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mi_ext</span><span class="op">)</span></span>
<span><span class="co"># add basemap</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">countries</span>, col <span class="op">=</span> <span class="st">"#cfcfcf"</span>, border <span class="op">=</span> <span class="st">"#888888"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># add data</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">abd_projected</span>, </span>
<span>     breaks <span class="op">=</span> <span class="va">bins</span>, col <span class="op">=</span> <span class="va">pal</span>, </span>
<span>     axes <span class="op">=</span> <span class="cn">FALSE</span>, legend <span class="op">=</span> <span class="cn">FALSE</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># add boundaries</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">countries</span>, col <span class="op">=</span> <span class="cn">NA</span>, border <span class="op">=</span> <span class="st">"#888888"</span>, lwd <span class="op">=</span> <span class="fl">3</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">states</span>, col <span class="op">=</span> <span class="cn">NA</span>, border <span class="op">=</span> <span class="st">"#888888"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add legend using the fields package</span></span>
<span><span class="co"># label the bottom, middle, and top</span></span>
<span><span class="va">labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">bins</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">label_breaks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">bins</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/fields/man/image.plot.html" class="external-link">image.plot</a></span><span class="op">(</span>zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="va">label_breaks</span>, col <span class="op">=</span> <span class="va">pal</span>,</span>
<span>           smallplot <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.90</span>, <span class="fl">0.93</span>, <span class="fl">0.15</span>, <span class="fl">0.85</span><span class="op">)</span>,</span>
<span>           legend.only <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>           axis.args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                            labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">labels</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>                            col.axis <span class="op">=</span> <span class="st">"black"</span>, fg <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                            cex.axis <span class="op">=</span> <span class="fl">0.9</span>, lwd.ticks <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                            line <span class="op">=</span> <span class="op">-</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="rasters_files/figure-html/map_basemap-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="trajectories">Extracting trajectories with uncertainty<a class="anchor" aria-label="anchor" href="#trajectories"></a>
</h2>
<p>Next, we’ll look at the temporal component of the relative abundance
data. Using the weekly relative abundance cubes, we can chart the change
in relative abundance throughout the year for a fixed location.
Furthermore, using the upper and lower confidence interval rasters, we
can add uncertainty estimates. We often refer to these as relative
abundance trajectories.</p>
<p>Let’s start by loading all the necessary relative abundance
cubes.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">abd_median</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_raster.html">load_raster</a></span><span class="op">(</span><span class="va">path</span>, product <span class="op">=</span> <span class="st">"abundance"</span>, </span>
<span>                          metric <span class="op">=</span> <span class="st">"median"</span>, resolution <span class="op">=</span> <span class="st">"lr"</span><span class="op">)</span></span>
<span><span class="va">abd_lower</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_raster.html">load_raster</a></span><span class="op">(</span><span class="va">path</span>, product <span class="op">=</span> <span class="st">"abundance"</span>,</span>
<span>                         metric <span class="op">=</span> <span class="st">"lower"</span>, resolution <span class="op">=</span> <span class="st">"lr"</span><span class="op">)</span></span>
<span><span class="va">abd_upper</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_raster.html">load_raster</a></span><span class="op">(</span><span class="va">path</span>, product <span class="op">=</span> <span class="st">"abundance"</span>, </span>
<span>                         metric <span class="op">=</span> <span class="st">"upper"</span>, resolution <span class="op">=</span> <span class="st">"lr"</span><span class="op">)</span></span></code></pre></div>
<p>Now we’ll extract the values for a fixed location.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set a point</span></span>
<span><span class="va">pt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st.html" class="external-link">st_point</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">88.1</span>, <span class="fl">46.7</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sfc.html" class="external-link">st_sfc</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">abd_median</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html" class="external-link">st_coordinates</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># extract</span></span>
<span><span class="va">traj_median</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/coerce.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">abd_median</span>, <span class="va">pt</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span></span>
<span><span class="va">traj_upper</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/coerce.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">abd_upper</span>, <span class="va">pt</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span></span>
<span><span class="va">traj_lower</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/coerce.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">abd_lower</span>, <span class="va">pt</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># plot trajectories</span></span>
<span><span class="va">plot_frame</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">traj_median</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                         y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">traj_median</span><span class="op">)</span>,</span>
<span>                         lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">traj_lower</span><span class="op">)</span>,</span>
<span>                         upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">traj_upper</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">plot_frame</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot_frame</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot_frame</span>, </span>
<span>              <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower</span>, ymax <span class="op">=</span> <span class="va">upper</span><span class="op">)</span>, </span>
<span>              alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Relative abundance"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Week"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_light</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="rasters_files/figure-html/trajectories_extract-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="stats">Regional statistics<a class="anchor" aria-label="anchor" href="#stats"></a>
</h2>
<p>In addition to maps and visualizations, the eBird Status and Trends
website provides a set of statistics summarizing the spatial data over
regions (countries and states) and seasons. The five regional statistics
are:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Mean relative abundance:</strong> the average estimated
relative abundance within the given region.</li>
<li>
<strong>Percentage of seasonal population:</strong> the sum of the
estimated relative abundance within the selected region divided by the
sum of the estimated relative abundance across the full range.</li>
<li>
<strong>Percentage of region occupied:</strong> the percentage of
the selected region within the range boundary of a species.</li>
<li>
<strong>Percentage of range in region:</strong> the fraction of a
species’ total range that falls within the selected region.</li>
<li>
<strong>Days of occupation in region:</strong> the number of days
that a species occupies the selected region, with occupation being
defined as spatially covering the selected region by at least 5% based
on estimated relative abundances averaged across the given season.</li>
</ol>
<p>These statistics can be downloaded from the Status and Trends website
for all regions and seasons for any given species; however, there may be
situations where you want to calculate them over different regions than
those provided. With that in mind, in this section we’ll cover how to
calculate a couple of these statistics: percent of population in region
and percent of region occupied. The remaining 3 statistics can be
calculated following the same approach with some modifications.</p>
<p>Since the example data used in this vignette is restricted to
Michigan, we’ll calculate the statistics over the counties in Michigan;
however, this approach can easily be extended to any set of regions.
Let’s start by downloading county boundaries for Michigan.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mi_counties</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/geodata/man/gadm.html" class="external-link">gadm</a></span><span class="op">(</span>country <span class="op">=</span> <span class="st">"USA"</span>, level <span class="op">=</span> <span class="fl">2</span>, path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">NAME_1</span> <span class="op">==</span> <span class="st">"Michigan"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>county <span class="op">=</span> <span class="va">NAME_2</span>, county_code <span class="op">=</span> <span class="va">HASC_2</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># remove lakes which aren't true counties</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">county_code</span> <span class="op">!=</span> <span class="st">"US.MI.WB"</span><span class="op">)</span></span>
<span><span class="co"># project to sinusoidal</span></span>
<span><span class="va">mi_counties_proj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">mi_counties</span>, crs <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">abd_median</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We’ll need the seasonal percent of population cubes and the seasonal
ranges for these calculations.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pop_seasonal</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_raster.html">load_raster</a></span><span class="op">(</span><span class="va">path</span>, product <span class="op">=</span> <span class="st">"percent-population"</span>, </span>
<span>                            period <span class="op">=</span> <span class="st">"seasonal"</span>, resolution <span class="op">=</span> <span class="st">"lr"</span><span class="op">)</span></span>
<span><span class="va">ranges</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_ranges.html">load_ranges</a></span><span class="op">(</span><span class="va">path</span>, resolution <span class="op">=</span> <span class="st">"lr"</span>, smoothed <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="percent-of-population">Percent of Population<a class="anchor" aria-label="anchor" href="#percent-of-population"></a>
</h3>
<p>Percent of population in regions is one of the simplest statistics to
calculate since a raster of percent of population is already provided;
we simply sum all the raster cells within each region polygon.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pctpop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">pop_seasonal</span>, <span class="va">mi_counties_proj</span>, fun <span class="op">=</span> <span class="va">sum</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># attach county attributes</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>county_code <span class="op">=</span> <span class="va">mi_counties</span><span class="op">$</span><span class="va">county_code</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># transpose to long format, one season per row</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">ID</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="va">county_code</span>, </span>
<span>               names_to <span class="op">=</span> <span class="st">"season"</span>,</span>
<span>               values_to <span class="op">=</span> <span class="st">"percent_population"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pctpop</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 3</span></span></span>
<span><span class="co">#&gt;   county_code season                 percent_population</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                               <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> US.MI.AC    breeding                          0.001<span style="text-decoration: underline;">56</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> US.MI.AC    nonbreeding                       0      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> US.MI.AC    prebreeding_migration             0.001<span style="text-decoration: underline;">05</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> US.MI.AC    postbreeding_migration            0.001<span style="text-decoration: underline;">34</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> US.MI.AG    breeding                          0.001<span style="text-decoration: underline;">78</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> US.MI.AG    nonbreeding                       0</span></span></code></pre></div>
<p>Let’s make a quick map comparing the breeding and non-breeding
percent of population within counties in Michigan.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># join back to county boundaries</span></span>
<span><span class="va">pctpop_proj</span> <span class="op">&lt;-</span> <span class="va">pctpop</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">season</span> <span class="op"><a href="https://rdrr.io/pkg/terra/man/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"breeding"</span>, <span class="st">"nonbreeding"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">mi_counties</span>, <span class="va">.</span>, by <span class="op">=</span> <span class="st">"county_code"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># transform to custom projection for plotting</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="va">crs</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">pctpop_proj</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">percent_population</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"sqrt"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html" class="external-link">guide_colorbar</a></span><span class="op">(</span>title.position <span class="op">=</span> <span class="st">"top"</span>, barwidth <span class="op">=</span> <span class="fl">15</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">season</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Seasonal percent of population in MI counties"</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">"Percent of population"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="rasters_files/figure-html/stats_pop-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="percent-of-region-occupied">Percent of region occupied<a class="anchor" aria-label="anchor" href="#percent-of-region-occupied"></a>
</h3>
<p>To calculate range-based stats it’s often easiest to use the range
polygons rather than the raster data. We can calculate the area of each
county, then calculate the area of intersection between the counties and
the ranges, and finally divide the two to get the percent of each region
occupied.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># add the area of each region</span></span>
<span><span class="va">mi_counties</span><span class="op">$</span><span class="va">area</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html" class="external-link">st_area</a></span><span class="op">(</span><span class="va">mi_counties</span><span class="op">)</span></span>
<span><span class="co"># for each season, intersect with the county boundaries and calculate area</span></span>
<span><span class="va">range_pct_occupied</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="va">ranges</span><span class="op">$</span><span class="va">season</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">range_pct_occupied</span> <span class="op">&lt;-</span> <span class="va">ranges</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">season</span> <span class="op">==</span> <span class="va">s</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">mi_counties</span>, <span class="va">.</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>percent_occupied <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html" class="external-link">st_area</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op">/</span> <span class="va">area</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">season</span>, <span class="va">county_code</span>, <span class="va">percent_occupied</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">range_pct_occupied</span>, <span class="va">.</span><span class="op">)</span></span>
<span>    </span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">range_pct_occupied</span><span class="op">)</span></span>
<span><span class="co">#&gt;     season county_code percent_occupied</span></span>
<span><span class="co">#&gt; 1 breeding    US.MI.AC        1.0000000</span></span>
<span><span class="co">#&gt; 2 breeding    US.MI.AG        1.0000000</span></span>
<span><span class="co">#&gt; 3 breeding    US.MI.AL        0.9686342</span></span>
<span><span class="co">#&gt; 4 breeding    US.MI.AP        1.0000000</span></span>
<span><span class="co">#&gt; 5 breeding    US.MI.AN        1.0000000</span></span>
<span><span class="co">#&gt; 6 breeding    US.MI.AR        1.0000000</span></span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="http://strimas.com" class="external-link">Matthew Strimas-Mackey</a>, Shawn Ligocki, <a href="http://twitter.com/tom_auer" class="external-link">Tom Auer</a>, Daniel Fink.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.5.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
