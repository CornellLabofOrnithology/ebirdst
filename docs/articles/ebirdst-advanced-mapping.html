<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generating Seasonal Abundance and Range Maps and Stats • ebirdst</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Generating Seasonal Abundance and Range Maps and Stats">
<meta property="og:description" content="ebirdst">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ebirdst</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/ebirdst.html">Get Started</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/ebirdst-intro-mapping.html">Introduction to Mapping</a>
    </li>
    <li>
      <a href="../articles/ebirdst-advanced-mapping.html">Advanced Mapping</a>
    </li>
    <li>
      <a href="../articles/ebirdst-non-raster.html">Non-raster Data</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Function Reference</a>
</li>
<li>
  <a href="../articles/product-changelog.html#2019-changelog">Changelog</a>
</li>
<li>
  <a href="../news/index.html">Version History</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/CornellLabofOrnithology/ebirdst/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="ebirdst-advanced-mapping_files/header-attrs-2.11/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Generating Seasonal Abundance and Range Maps and Stats</h1>
                        <h4 data-toc-skip class="author">Matt Strimas-Mackey, Tom Auer, Daniel Fink</h4>
            
            <h4 data-toc-skip class="date">2021-12-02</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/CornellLabofOrnithology/ebirdst/blob/master/vignettes/ebirdst-advanced-mapping.Rmd" class="external-link"><code>vignettes/ebirdst-advanced-mapping.Rmd</code></a></small>
      <div class="hidden name"><code>ebirdst-advanced-mapping.Rmd</code></div>

    </div>

    
    
<div id="outline" class="section level1">
<h1 class="hasAnchor">
<a href="#outline" class="anchor" aria-hidden="true"></a>Outline</h1>
<ol style="list-style-type: decimal">
<li><a href="#introduction">Introduction</a></li>
<li><a href="#data-download">Data Download</a></li>
<li><a href="#seasonal-abundance">Seasonal Abundance</a></li>
<li><a href="#abundance-maps">Abundance Maps</a></li>
<li><a href="#range-maps">Range Maps</a></li>
<li><a href="#regional-statistics">Regional Statistics</a></li>
</ol>
</div>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor" aria-hidden="true"></a>Introduction</h1>
<p>This vignette describes how to recreate the seasonal map products found on the <a href="https://ebird.org/science/status-and-trends" class="external-link">eBird Status and Trends pages</a>. First, the vignette will cover how to average the abundance data seasonally, then it will proceed with examples of making abundance maps, aggregating and smoothing data for range maps, and, finally, provide examples of calculating regional summary statistic. Throughout this vignette we will use the simplified example dataset available through the <code><a href="../reference/ebirdst_download.html">ebirdst_download()</a></code> function, which consists of the Yellow-bellied Sapsucker data spatially subset to the state of Michigan. However, these methods can be applied to the full datasets for any of the eBird Status and Trends species.</p>
<p>Let’s begin by loading all the packages we’ll need for this vignette.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/CornellLabofOrnithology/ebirdst" class="external-link">ebirdst</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster" class="external-link">raster</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://strimas.com/smoothr/" class="external-link">smoothr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ropenscilabs/rnaturalearth" class="external-link">rnaturalearth</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
<span class="co"># resolve namespace conflicts</span>
<span class="va">select</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="va"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/s2.html" class="external-link">sf_use_s2</a></span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; Spherical geometry (s2) switched off</span></code></pre></div>
</div>
<div id="data-download" class="section level1">
<h1 class="hasAnchor">
<a href="#data-download" class="anchor" aria-hidden="true"></a>Data Download</h1>
<p>Before we do anything else, we’ll need to download and load the example abundance data for Yellow-bellied Sapsucker.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sp_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ebirdst_download.html">ebirdst_download</a></span><span class="op">(</span>species <span class="op">=</span> <span class="st">"example_data"</span><span class="op">)</span>
<span class="co"># load the abundance data</span>
<span class="co"># this automatically labels layers with their dates</span>
<span class="va">abd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_raster.html">load_raster</a></span><span class="op">(</span><span class="va">sp_path</span>, <span class="st">"abundance"</span><span class="op">)</span></code></pre></div>
<p>The abundance data now consist of a <code>RasterStack</code> object with 52 layers, each corresponding to the relative abundance for a single week.</p>
<p>We’ll also need some additional spatial data (state and country borders, lakes, etc.) to provide context for the maps we’ll make. <a href="https://www.naturalearthdata.com/" class="external-link">Natural Earth</a> is the best source for free map data and there’s an associated R package (<code>rnaturalearth</code>) for accessing the data. However, we’ll work with a prepared subset of the data stored in the <code>ebirdst</code> GitHub repository. For all the maps in this vignette, we’ll use the Eckert IV projection, a good option for continental scale maps.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">proj</span> <span class="op">&lt;-</span> <span class="st">"+proj=eck4 +lon_0=-90 +x_0=0 +y_0=0 +ellps=WGS84"</span>

<span class="co"># download natural earth data</span>
<span class="va">temp_gpkg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".gpkg"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"https://github.com/CornellLabofOrnithology/ebirdst/raw/"</span>,
          <span class="st">"main/data-raw/ebirdst_gis-data.gpkg"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span><span class="va">temp_gpkg</span><span class="op">)</span>

<span class="co"># land polygon</span>
<span class="va">ne_land</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="va">temp_gpkg</span>, layer <span class="op">=</span> <span class="st">"ne_land"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="va">proj</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="op">)</span>
<span class="co"># country lines</span>
<span class="va">ne_country_lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="va">temp_gpkg</span>, layer <span class="op">=</span> <span class="st">"ne_country_lines"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="va">proj</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="op">)</span>
<span class="co"># state lines</span>
<span class="va">ne_state_lines</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="va">temp_gpkg</span>, layer <span class="op">=</span> <span class="st">"ne_state_lines"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="va">proj</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="op">)</span>
<span class="co"># rivers</span>
<span class="va">ne_rivers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="va">temp_gpkg</span>, layer <span class="op">=</span> <span class="st">"ne_rivers"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="va">proj</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="op">)</span>
<span class="co"># lakes</span>
<span class="va">ne_lakes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="va">temp_gpkg</span>, layer <span class="op">=</span> <span class="st">"ne_lakes"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="va">proj</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div id="seasonal-abundance" class="section level1">
<h1 class="hasAnchor">
<a href="#seasonal-abundance" class="anchor" aria-hidden="true"></a>Seasonal Abundance</h1>
<p>Generally, the seasons for eBird Status and Trends products are defined on a species-specific basis through expert review. For information on the details of defining seasons, please see the <a href="https://ebird.org/science/status-and-trends/faq#seasons" class="external-link">seasons section of the FAQ</a>. While it is certainly possible to define your own seasons when making seasonal abundance and range maps, if you want to recreate the products with the same seasons as the website, you’ll need to use the definitions included in the <code>ebirdst_runs</code> data frame included in this package.</p>
<p>Let’s start by getting the seasonal definitions for Yellow-bellied Sapsucker and transforming the data into a more usable format. For some species, expert review may have indicated that the models are poor in certain seasons. These problematic seasons are identified by missing dates in <code>ebirdst_runs</code> for the season in question. Although all seasons passed review for Yellow-bellied Sapsucker, for generality I’ll add an additional column (<code>passed</code>) indicating whether a seasonal model passed review.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># subset to the yellow-bellied sapsucker season definitions</span>
<span class="va">run_review</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ebirdst_runs</span>, <span class="va">species_code</span> <span class="op">==</span> <span class="st">"yebsap"</span><span class="op">)</span>
<span class="va">yebsap_dates</span> <span class="op">&lt;-</span> <span class="va">run_review</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="co"># just keep the seasonal definition columns</span>
  <span class="fu"><a href="https://rdrr.io/pkg/raster/man/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="st">"(start)|(end)"</span><span class="op">)</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="st">"year_round"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="co"># transpose</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html" class="external-link">gather</a></span><span class="op">(</span><span class="st">"label"</span>, <span class="st">"date"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="co"># spread data so start and end dates are in separate columns</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/separate.html" class="external-link">separate</a></span><span class="op">(</span><span class="va">label</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"season"</span>, <span class="st">"start_end"</span><span class="op">)</span>, <span class="st">"_(?=s|e)"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/spread.html" class="external-link">spread</a></span><span class="op">(</span><span class="va">start_end</span>, <span class="va">date</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/pkg/raster/man/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">season</span>, start_dt <span class="op">=</span> <span class="va">start</span>, end_dt <span class="op">=</span> <span class="va">end</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">season</span> <span class="op">!=</span> <span class="st">"resident"</span><span class="op">)</span>
<span class="co"># did the season pass review</span>
<span class="va">quality_rating</span> <span class="op">&lt;-</span> <span class="va">run_review</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">yebsap_dates</span><span class="op">$</span><span class="va">season</span>, <span class="st">"_quality"</span><span class="op">)</span><span class="op">]</span>
<span class="va">yebsap_dates</span><span class="op">$</span><span class="va">pass</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">quality_rating</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span>
<span class="va">yebsap_dates</span>
<span class="co">#&gt; # A tibble: 4 × 4</span>
<span class="co">#&gt;   season                 start_dt   end_dt     pass </span>
<span class="co">#&gt;   &lt;chr&gt;                  &lt;date&gt;     &lt;date&gt;     &lt;lgl&gt;</span>
<span class="co">#&gt; 1 breeding               2019-05-24 2019-09-07 TRUE </span>
<span class="co">#&gt; 2 nonbreeding            2019-11-23 2019-03-08 TRUE </span>
<span class="co">#&gt; 3 postbreeding_migration 2019-09-14 2019-11-16 TRUE </span>
<span class="co">#&gt; 4 prebreeding_migration  2019-03-15 2019-05-17 TRUE</span></code></pre></div>
<p>Now, we’ll use these season definitions to assign each of the weekly abundance layers to a season.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># dates for each abundance layer</span>
<span class="va">weeks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/parse_raster_dates.html">parse_raster_dates</a></span><span class="op">(</span><span class="va">abd</span><span class="op">)</span>
<span class="co"># assign to seasons</span>
<span class="va">weeks_season</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA_character_</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">weeks</span><span class="op">)</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">yebsap_dates</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">s</span> <span class="op">&lt;-</span> <span class="va">yebsap_dates</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span>
  <span class="co"># skip seasona assignment if season failed</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">s</span><span class="op">$</span><span class="va">pass</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw">next</span><span class="op">(</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="co"># handle seasons cross jan 1 separately</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">s</span><span class="op">$</span><span class="va">start_dt</span> <span class="op">&lt;=</span> <span class="va">s</span><span class="op">$</span><span class="va">end_dt</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">in_season</span> <span class="op">&lt;-</span> <span class="va">weeks</span> <span class="op">&gt;=</span> <span class="va">s</span><span class="op">$</span><span class="va">start_dt</span> <span class="op">&amp;</span> <span class="va">weeks</span> <span class="op">&lt;=</span> <span class="va">s</span><span class="op">$</span><span class="va">end_dt</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="va">in_season</span> <span class="op">&lt;-</span> <span class="va">weeks</span> <span class="op">&gt;=</span> <span class="va">s</span><span class="op">$</span><span class="va">start_dt</span> <span class="op">|</span> <span class="va">weeks</span> <span class="op">&lt;=</span> <span class="va">s</span><span class="op">$</span><span class="va">end_dt</span>
  <span class="op">}</span>
  <span class="va">weeks_season</span><span class="op">[</span><span class="va">in_season</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">s</span><span class="op">$</span><span class="va">season</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">weeks_season</span><span class="op">)</span>
<span class="co">#&gt; weeks_season</span>
<span class="co">#&gt;               breeding            nonbreeding postbreeding_migration </span>
<span class="co">#&gt;                     16                     16                     10 </span>
<span class="co">#&gt;  prebreeding_migration </span>
<span class="co">#&gt;                     10</span></code></pre></div>
<p>Finally, let’s average all the weeks within each season to produce seasonal relative abundance rasters.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># drop weeks not assigned to season</span>
<span class="va">week_pass</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">weeks_season</span><span class="op">)</span>
<span class="va">abd</span> <span class="op">&lt;-</span> <span class="va">abd</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">week_pass</span><span class="op">)</span><span class="op">]</span><span class="op">]</span>
<span class="va">weeks</span> <span class="op">&lt;-</span> <span class="va">weeks</span><span class="op">[</span><span class="va">week_pass</span><span class="op">]</span>
<span class="va">weeks_season</span> <span class="op">&lt;-</span> <span class="va">weeks_season</span><span class="op">[</span><span class="va">week_pass</span><span class="op">]</span>
<span class="co"># average over weeks in season</span>
<span class="va">mean_season</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/pkg/raster/man/calc.html" class="external-link">calc</a></span><span class="op">(</span><span class="va">abd</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">weeks_season</span> <span class="op">==</span> <span class="va">s</span><span class="op">)</span><span class="op">]</span><span class="op">]</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">seasons</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">weeks_season</span><span class="op">)</span>
<span class="va">abd_season</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">seasons</span>, <span class="va">mean_season</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html" class="external-link">stack</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="va">seasons</span><span class="op">)</span>
<span class="va">abd_season</span>
<span class="co">#&gt; class      : RasterStack </span>
<span class="co">#&gt; dimensions : 244, 260, 63440, 4  (nrow, ncol, ncell, nlayers)</span>
<span class="co">#&gt; resolution : 2962.807, 2962.809  (x, y)</span>
<span class="co">#&gt; extent     : -7203933, -6433604, 4635982, 5358907  (xmin, xmax, ymin, ymax)</span>
<span class="co">#&gt; crs        : +proj=sinu +lon_0=0 +x_0=0 +y_0=0 +R=6371007.181 +units=m +no_defs </span>
<span class="co">#&gt; names      : nonbreeding, prebreeding_migration,   breeding, postbreeding_migration </span>
<span class="co">#&gt; min values :           0,                     0,          0,                      0 </span>
<span class="co">#&gt; max values :  0.09554554,            1.93999040, 1.93377865,             0.62279958</span></code></pre></div>
</div>
<div id="abundance-maps" class="section level1">
<h1 class="hasAnchor">
<a href="#abundance-maps" class="anchor" aria-hidden="true"></a>Abundance Maps</h1>
<p>Before we create maps of seasonal relative abundance we need to account for two addition considerations that the online maps make: whether to split pre- and post-breeding migration and whether to explicitly show the year-round distribution as a separate color. For species that use different paths for their two migrations (less than 40% overlap) we show pre-breeding migration (green) and post-breeding migration (yellow) separately.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">migration_threshold</span> <span class="op">&lt;-</span> <span class="fl">0.4</span>
<span class="va">mig_seasons</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"prebreeding_migration"</span>, <span class="st">"postbreeding_migration"</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">mig_seasons</span> <span class="op"><a href="https://rdrr.io/pkg/raster/man/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">abd_season</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># identify areas with abundance in only one season</span>
  <span class="va">abd_nz</span> <span class="op">&lt;-</span> <span class="va">abd_season</span><span class="op">[[</span><span class="va">mig_seasons</span><span class="op">]</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">0</span>
  <span class="va">just_pre</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/mask.html" class="external-link">mask</a></span><span class="op">(</span><span class="va">abd_nz</span><span class="op">[[</span><span class="st">"prebreeding_migration"</span><span class="op">]</span><span class="op">]</span>,
                   <span class="va">abd_nz</span><span class="op">[[</span><span class="st">"postbreeding_migration"</span><span class="op">]</span><span class="op">]</span>, 
                   maskvalue <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
  <span class="va">just_post</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/mask.html" class="external-link">mask</a></span><span class="op">(</span><span class="va">abd_nz</span><span class="op">[[</span><span class="st">"postbreeding_migration"</span><span class="op">]</span><span class="op">]</span>,
                    <span class="va">abd_nz</span><span class="op">[[</span><span class="st">"prebreeding_migration"</span><span class="op">]</span><span class="op">]</span>, 
                    maskvalue <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
  <span class="co"># count the number of cells with abundance in only one season</span>
  <span class="va">n_just</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/cellStats.html" class="external-link">cellStats</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html" class="external-link">stack</a></span><span class="op">(</span><span class="va">just_pre</span>, <span class="va">just_post</span><span class="op">)</span>, <span class="va">sum</span><span class="op">)</span>
  <span class="va">n_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/cellStats.html" class="external-link">cellStats</a></span><span class="op">(</span><span class="va">abd_nz</span>, <span class="va">sum</span><span class="op">)</span>
  <span class="co"># is the proportion of one season cells above the 40% threshold</span>
  <span class="va">split_migration</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">n_just</span> <span class="op">/</span> <span class="va">n_all</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">migration_threshold</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  <span class="va">split_migration</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span>
<span class="op">}</span>
<span class="va">n_just</span> <span class="op">/</span> <span class="va">n_all</span>
<span class="co">#&gt;  prebreeding_migration postbreeding_migration </span>
<span class="co">#&gt;             0.09867184             0.01005795</span>
<span class="va">split_migration</span>
<span class="co">#&gt; [1] FALSE</span></code></pre></div>
<p>In this case, there is essentially complete overlap between pre- and post-breeding migration, so we won’t split them into separate colors on the map. Next, we’ll calculate the average annual abundance, which we’ll display as a separate color if at least 1% of the range is occupied in all four seasons.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">threshold_yearround</span> <span class="op">&lt;-</span> <span class="fl">0.01</span>
<span class="co"># decide whether to show year-round layer</span>
<span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/nlayers.html" class="external-link">nlayers</a></span><span class="op">(</span><span class="va">abd_season</span><span class="op">)</span> <span class="op">==</span> <span class="fl">4</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># annual abundance</span>
  <span class="va">abd_yr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/calc.html" class="external-link">calc</a></span><span class="op">(</span><span class="va">abd</span>, fun <span class="op">=</span> <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="co"># mask out cells that aren't occupied year-round</span>
  <span class="va">year_round</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/calc.html" class="external-link">calc</a></span><span class="op">(</span><span class="va">abd_season</span> <span class="op">&gt;</span> <span class="fl">0</span>, fun <span class="op">=</span> <span class="va">sum</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">==</span> <span class="fl">4</span>
  <span class="va">abd_yr_mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/mask.html" class="external-link">mask</a></span><span class="op">(</span><span class="va">abd_yr</span>, <span class="va">year_round</span>, maskvalue <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
  <span class="co"># determine proportion of celss that are occupied year round</span>
  <span class="va">n_yr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/cellStats.html" class="external-link">cellStats</a></span><span class="op">(</span><span class="va">abd_yr_mask</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="va">sum</span><span class="op">)</span>
  <span class="va">n_an</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/cellStats.html" class="external-link">cellStats</a></span><span class="op">(</span><span class="va">abd_yr</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="va">sum</span><span class="op">)</span>
  <span class="co"># only show year round abundance if it's above 1% of range threshold</span>
  <span class="va">show_yearround</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="op">(</span><span class="va">n_yr</span> <span class="op">/</span> <span class="va">n_an</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">threshold_yearround</span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  <span class="va">show_yearround</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span>
<span class="op">}</span>
<span class="va">show_yearround</span>
<span class="co">#&gt; [1] FALSE</span></code></pre></div>
<p>Mapping relative abundance across the full-annual cycle requires a specialized set of color bins in order to ensure the full range of abundance values is effectively displayed. For simplicity, we’ll use quantile bins based on the seasonal abundance, however, you could also use the function <code><a href="../reference/calc_bins.html">calc_bins()</a></code> to calculate the optimal break points of bins for Status and Trends abundance data.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">vals</span> <span class="op">&lt;-</span> <span class="va">abd_season</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/pkg/raster/man/getValues.html" class="external-link">getValues</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">bin_breaks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">vals</span><span class="op">[</span><span class="va">vals</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, by <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span>
<span class="va">lbls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="va">bin_breaks</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"5%"</span>, <span class="st">"50%"</span>, <span class="st">"95%"</span><span class="op">)</span><span class="op">]</span>, <span class="fl">3</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">vals</span><span class="op">)</span></code></pre></div>
<p>Now that everything is in place, we can actually make the seasonal relative abundance map! Note that the Status and Trends maps distinguish between regions of zero abundance and <a href="https://ebird.org/science/status-and-trends/faq#no-prediction" class="external-link">regions with no prediction</a>, which are displayed in different shades of gray, and regions with non-zero abundance, shown in color. To account for this, we’ll need to generate a raster layer delineating the region within which predictions were made.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># project the abundance data to mollweide</span>
<span class="co"># use nearest neighbour resampling to preserve true zeros</span>
<span class="va">abd_season_proj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/projectRaster.html" class="external-link">projectRaster</a></span><span class="op">(</span><span class="va">abd_season</span>, crs <span class="op">=</span> <span class="va">proj</span>, method <span class="op">=</span> <span class="st">"ngb"</span><span class="op">)</span>
<span class="co"># determine spatial extent for plotting</span>
<span class="va">ext</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_full_extent.html">calc_full_extent</a></span><span class="op">(</span><span class="va">abd_season_proj</span><span class="op">)</span>
<span class="co"># set the plotting order of the seasons</span>
<span class="va">season_order</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"postbreeding_migration"</span>, <span class="st">"prebreeding_migration"</span>, 
                  <span class="st">"nonbreeding"</span>, <span class="st">"breeding"</span><span class="op">)</span>

<span class="co"># prediction region, cells with predicted value in at least one week</span>
<span class="va">pred_region</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/calc.html" class="external-link">calc</a></span><span class="op">(</span><span class="va">abd_season_proj</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co"># mask to land area</span>
<span class="va">ne_land_buffer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="va">ne_land</span>, dist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/resolution.html" class="external-link">res</a></span><span class="op">(</span><span class="va">pred_region</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">pred_region</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/mask.html" class="external-link">mask</a></span><span class="op">(</span><span class="va">pred_region</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/coerce-methods.html" class="external-link">as_Spatial</a></span><span class="op">(</span><span class="va">ne_land_buffer</span><span class="op">)</span><span class="op">)</span>

<span class="co"># remove zeros from abundance layers</span>
<span class="va">abd_no_zero</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/subs.html" class="external-link">subs</a></span><span class="op">(</span><span class="va">abd_season_proj</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">0</span>, to <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span>, 
                    subsWithNA <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># set up plot area</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span> , <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ne_land</span>, col <span class="op">=</span> <span class="st">"#cfcfcf"</span>, border <span class="op">=</span> <span class="cn">NA</span>, 
     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">ext</span><span class="op">@</span><span class="va">xmin</span>, <span class="va">ext</span><span class="op">@</span><span class="va">xmax</span><span class="op">)</span>,
     ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">ext</span><span class="op">@</span><span class="va">ymin</span>, <span class="va">ext</span><span class="op">@</span><span class="va">ymax</span><span class="op">)</span><span class="op">)</span>
<span class="co"># prediction region and explicit zeros</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pred_region</span>, col <span class="op">=</span> <span class="st">"#e6e6e6"</span>, maxpixels <span class="op">=</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html" class="external-link">ncell</a></span><span class="op">(</span><span class="va">pred_region</span><span class="op">)</span>,
     legend <span class="op">=</span> <span class="cn">FALSE</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co"># lakes</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ne_lakes</span>, col <span class="op">=</span> <span class="st">"#ffffff"</span>, border <span class="op">=</span>  <span class="st">"#444444"</span>, lwd <span class="op">=</span> <span class="fl">0.5</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co"># land border</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ne_land</span>, col <span class="op">=</span> <span class="cn">NA</span>, border <span class="op">=</span> <span class="st">"#444444"</span>, lwd <span class="op">=</span> <span class="fl">0.5</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co"># seasonal layer</span>
<span class="va">plot_seasons</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/intersect.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">season_order</span>, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">abd_no_zero</span><span class="op">)</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="va">plot_seasons</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># handle splitting of migration seasons into different colors</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">split_migration</span> <span class="op">&amp;&amp;</span> <span class="va">s</span> <span class="op"><a href="https://rdrr.io/pkg/raster/man/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"prebreeding_migration"</span>, 
                                   <span class="st">"postbreeding_migration"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">pal_season</span> <span class="op">&lt;-</span> <span class="st">"migration"</span>
    
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="va">pal_season</span> <span class="op">&lt;-</span> <span class="va">s</span>
  <span class="op">}</span>
  <span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/abundance_palette.html">abundance_palette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">bin_breaks</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, <span class="va">pal_season</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">abd_no_zero</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span>, col <span class="op">=</span> <span class="va">pal</span>, breaks <span class="op">=</span> <span class="va">bin_breaks</span>,
       maxpixels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html" class="external-link">ncell</a></span><span class="op">(</span><span class="va">abd_no_zero</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,
       legend <span class="op">=</span> <span class="cn">FALSE</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span>
<span class="co"># year round</span>
<span class="kw">if</span> <span class="op">(</span><span class="va">show_yearround</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">year_round_proj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/projectRaster.html" class="external-link">projectRaster</a></span><span class="op">(</span><span class="va">year_round</span>, crs <span class="op">=</span> <span class="va">mollweide</span>, method <span class="op">=</span> <span class="st">"ngb"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">year_round_proj</span>, 
       col <span class="op">=</span> <span class="fu"><a href="../reference/abundance_palette.html">abundance_palette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">bin_breaks</span><span class="op">$</span><span class="va">bins</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, <span class="st">"year_round"</span><span class="op">)</span>, 
       breaks <span class="op">=</span> <span class="va">bin_breaks</span><span class="op">$</span><span class="va">bins</span>,
       maxpixels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/ncell.html" class="external-link">ncell</a></span><span class="op">(</span><span class="va">year_round_proj</span><span class="op">)</span>,
       legend <span class="op">=</span> <span class="cn">FALSE</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span>
<span class="co"># linework</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ne_rivers</span>, col <span class="op">=</span> <span class="st">"#ffffff"</span>, lwd <span class="op">=</span> <span class="fl">0.75</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ne_state_lines</span>, col <span class="op">=</span> <span class="st">"#ffffff"</span>, lwd <span class="op">=</span> <span class="fl">1.5</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ne_country_lines</span>, col <span class="op">=</span> <span class="st">"#ffffff"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="co"># legends</span>
<span class="va">legend_seasons</span> <span class="op">&lt;-</span> <span class="va">plot_seasons</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">split_migration</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">legend_seasons</span><span class="op">[</span><span class="va">legend_seasons</span> <span class="op"><a href="https://rdrr.io/pkg/raster/man/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"prebreeding_migration"</span>, 
                                       <span class="st">"postbreeding_migration"</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"migration"</span>
  <span class="va">legend_seasons</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">legend_seasons</span><span class="op">)</span>
<span class="op">}</span>
<span class="kw">if</span> <span class="op">(</span><span class="va">show_yearround</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">legend_seasons</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">legend_seasons</span>, <span class="st">"year_round"</span><span class="op">)</span>
<span class="op">}</span>
<span class="co"># thin out labels</span>
<span class="co"># plot legends</span>
<span class="va">lbl_at</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">lbls</span><span class="op">)</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">legend_seasons</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/abundance_palette.html">abundance_palette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">bin_breaks</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, <span class="va">legend_seasons</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">axis_args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>at <span class="op">=</span> <span class="va">lbl_at</span>, labels <span class="op">=</span> <span class="va">lbls</span>, line <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,
                      cex.axis <span class="op">=</span> <span class="fl">0.75</span>, lwd <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="va">axis_args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>at <span class="op">=</span> <span class="va">lbl_at</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">lbls</span><span class="op">)</span><span class="op">)</span>,
                      cex.axis <span class="op">=</span> <span class="fl">0.75</span>, lwd <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="va">legend_title</span> <span class="op">&lt;-</span> <span class="va">legend_seasons</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html" class="external-link">str_replace_all</a></span><span class="op">(</span><span class="st">"_"</span>, <span class="st">" "</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html" class="external-link">str_to_title</a></span><span class="op">(</span><span class="op">)</span>
  <span class="fu">fields</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/fields/man/image.plot.html" class="external-link">image.plot</a></span><span class="op">(</span>zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, 
                     legend.only <span class="op">=</span> <span class="cn">TRUE</span>, 
                     breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">bin_breaks</span><span class="op">)</span><span class="op">)</span>, 
                     col <span class="op">=</span> <span class="va">pal</span>,
                     smallplot <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.35</span>, <span class="fl">0.01</span> <span class="op">+</span> <span class="fl">0.06</span> <span class="op">*</span> <span class="va">i</span>, <span class="fl">0.03</span> <span class="op">+</span> <span class="fl">0.06</span> <span class="op">*</span> <span class="va">i</span><span class="op">)</span>,
                     horizontal <span class="op">=</span> <span class="cn">TRUE</span>,
                     axis.args <span class="op">=</span> <span class="va">axis_args</span>,
                     legend.args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">legend_title</span>, side <span class="op">=</span> <span class="fl">3</span>, 
                                        cex <span class="op">=</span> <span class="fl">0.9</span>, col <span class="op">=</span> <span class="st">"black"</span>, line <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"Yellow-bellied Sapsucker Relative Abundance"</span>, 
      line <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, cex.main <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<p><img src="ebirdst-advanced-mapping_files/figure-html/abd-map-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div id="range-maps" class="section level1">
<h1 class="hasAnchor">
<a href="#range-maps" class="anchor" aria-hidden="true"></a>Range Maps</h1>
<p>The eBird Status and Trends range maps delineate the boundary of regions with non-zero relative abundance for a given species. We’ll start by aggregating the raster layers to a coarser resolution to speed up processing, then convert the boundaries of non-zero abundance regions to polygons. We’ll also convert the prediction areas to polygons so we can distinguish where the species is predicted to not occur from where it was not modeled.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># aggregate</span>
<span class="va">abd_season_agg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">abd_season_proj</span>, fact <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="co"># raster to polygon, one season at a time</span>
<span class="va">range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">pred_area</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">abd_season_agg</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># range</span>
  <span class="va">range</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/rasterToPolygons.html" class="external-link">rasterToPolygons</a></span><span class="op">(</span><span class="va">abd_season_agg</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span>, 
                                 fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">{</span><span class="va">y</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">}</span>, 
                                 digits <span class="op">=</span> <span class="fl">6</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html" class="external-link">st_as_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="co"># combine polygon pieces into a single multipolygon</span>
    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_precision.html" class="external-link">st_set_precision</a></span><span class="op">(</span><span class="fl">1e6</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf.html" class="external-link">st_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="co"># tag layers with season</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>season <span class="op">=</span> <span class="va">s</span>, layer <span class="op">=</span> <span class="st">"range"</span><span class="op">)</span>
  <span class="co"># prediction area</span>
  <span class="va">pred_area</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/rasterToPolygons.html" class="external-link">rasterToPolygons</a></span><span class="op">(</span><span class="va">abd_season_agg</span><span class="op">[[</span><span class="va">s</span><span class="op">]</span><span class="op">]</span>, 
                                     fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">{</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">}</span>, 
                                     digits <span class="op">=</span> <span class="fl">6</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html" class="external-link">st_as_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="co"># combine polygon pieces into a single multipolygon</span>
    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_precision.html" class="external-link">st_set_precision</a></span><span class="op">(</span><span class="fl">1e6</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf.html" class="external-link">st_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="co"># tag layers with season</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>season <span class="op">=</span> <span class="va">s</span>, layer <span class="op">=</span> <span class="st">"prediction_area"</span><span class="op">)</span>
<span class="op">}</span>
<span class="co"># combine the sf objects for all seasons</span>
<span class="va">range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://www.math.uzh.ch/pages/spam//reference/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">range</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">pred_area</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">range</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
<span class="fu"><a href="https://www.math.uzh.ch/pages/spam//reference/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">range</span><span class="op">)</span>
<span class="co">#&gt; Simple feature collection with 8 features and 2 fields</span>
<span class="co">#&gt; Geometry type: MULTIPOLYGON</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: -42798.85 ymin: 5192682 xmax: 642641.1 ymax: 5888862</span>
<span class="co">#&gt; CRS:           +proj=eck4 +lon_0=-90 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs</span>
<span class="co">#&gt; Precision:     1e+06 </span>
<span class="co">#&gt;                   season           layer                       geometry</span>
<span class="co">#&gt; 1            nonbreeding           range MULTIPOLYGON (((269681.1 52...</span>
<span class="co">#&gt; 2  prebreeding_migration           range MULTIPOLYGON (((27761.15 56...</span>
<span class="co">#&gt; 3               breeding           range MULTIPOLYGON (((47921.15 56...</span>
<span class="co">#&gt; 4 postbreeding_migration           range MULTIPOLYGON (((68081.15 56...</span>
<span class="co">#&gt; 5            nonbreeding prediction_area MULTIPOLYGON (((27761.15 56...</span>
<span class="co">#&gt; 6  prebreeding_migration prediction_area MULTIPOLYGON (((27761.15 56...</span>
<span class="co">#&gt; 7               breeding prediction_area MULTIPOLYGON (((27761.15 56...</span>
<span class="co">#&gt; 8 postbreeding_migration prediction_area MULTIPOLYGON (((27761.15 56...</span></code></pre></div>
<p>Converting from raster to polygons frequently yields tiny fragments of polygons and jagged polygon edges, which result in maps that aren’t very aesthetically pleasing. To address this, we’ll apply some algorithms from the <code>smoothr</code> package to clean up the polygons.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># clean and smooth</span>
<span class="va">cell_area</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1.5</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/prod.html" class="external-link">prod</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/resolution.html" class="external-link">res</a></span><span class="op">(</span><span class="va">abd_season_agg</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">range_smooth</span> <span class="op">&lt;-</span> <span class="va">range</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="co"># drop fragment polygons smaller than 1.5 times the aggregated cell size</span>
  <span class="fu"><a href="https://strimas.com/smoothr/reference/drop_crumbs.html" class="external-link">drop_crumbs</a></span><span class="op">(</span>threshold <span class="op">=</span> <span class="va">cell_area</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="co"># drop holes in polygons smaller than 1.5 times the aggregated cell size</span>
  <span class="fu"><a href="https://strimas.com/smoothr/reference/fill_holes.html" class="external-link">fill_holes</a></span><span class="op">(</span>threshold <span class="op">=</span> <span class="va">cell_area</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="co"># smooth the polygon edges</span>
  <span class="fu"><a href="https://strimas.com/smoothr/reference/smooth.html" class="external-link">smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"ksmooth"</span>, smoothness <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="co"># clip zeros to land border, range to buffered land to handle coastal species</span>
<span class="va">range_split</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">range_smooth</span>, <span class="va">range_smooth</span><span class="op">$</span><span class="va">layer</span><span class="op">)</span>
<span class="va">range_smooth</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://www.math.uzh.ch/pages/spam//reference/cbind.html" class="external-link">rbind</a></span><span class="op">(</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">range_split</span><span class="op">$</span><span class="va">range</span>, <span class="va">ne_land_buffer</span><span class="op">)</span>,
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">range_split</span><span class="op">$</span><span class="va">prediction_area</span>, <span class="va">ne_land</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Finally, we can produce a seasonal range map in a similar fashion to the abundance map above.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># range map color palette</span>
<span class="va">range_palette</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>nonbreeding <span class="op">=</span> <span class="st">"#1d6996"</span>,
                   prebreeding_migration <span class="op">=</span> <span class="st">"#73af48"</span>,
                   breeding <span class="op">=</span> <span class="st">"#cc503e"</span>,
                   postbreeding_migration <span class="op">=</span> <span class="st">"#edad08"</span>,
                   migration <span class="op">=</span> <span class="st">"#edad08"</span>,
                   year_round <span class="op">=</span> <span class="st">"#6f4070"</span><span class="op">)</span>

<span class="co"># set up plot area</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span> , <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ne_land</span>, col <span class="op">=</span> <span class="st">"#cfcfcf"</span>, border <span class="op">=</span> <span class="cn">NA</span>, 
     xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">ext</span><span class="op">@</span><span class="va">xmin</span>, <span class="va">ext</span><span class="op">@</span><span class="va">xmax</span><span class="op">)</span>,
     ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">ext</span><span class="op">@</span><span class="va">ymin</span>, <span class="va">ext</span><span class="op">@</span><span class="va">ymax</span><span class="op">)</span><span class="op">)</span>
<span class="co"># prediction region and explicit zeros</span>
<span class="va">annual_pred_area</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">range_smooth</span>, <span class="va">layer</span> <span class="op">==</span> <span class="st">"prediction_area"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">annual_pred_area</span>, col <span class="op">=</span> <span class="st">"#e6e6e6"</span>, border <span class="op">=</span> <span class="cn">NA</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co"># lakes</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ne_lakes</span>, col <span class="op">=</span> <span class="st">"#ffffff"</span>, border <span class="op">=</span>  <span class="st">"#444444"</span>, lwd <span class="op">=</span> <span class="fl">0.5</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co"># land border</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ne_land</span>, col <span class="op">=</span> <span class="cn">NA</span>, border <span class="op">=</span> <span class="st">"#444444"</span>, lwd <span class="op">=</span> <span class="fl">0.5</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="co"># seasonal layer</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/intersect.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">season_order</span>, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">range_smooth</span><span class="op">$</span><span class="va">season</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># handle splitting of migration seasons into different colors</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">split_migration</span> <span class="op">&amp;&amp;</span> <span class="va">s</span> <span class="op"><a href="https://rdrr.io/pkg/raster/man/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"prebreeding_migration"</span>, 
                                   <span class="st">"postbreeding_migration"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">col_season</span> <span class="op">&lt;-</span> <span class="st">"migration"</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="va">col_season</span> <span class="op">&lt;-</span> <span class="va">s</span>
  <span class="op">}</span>
  <span class="va">rng_season</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">range_smooth</span>, <span class="va">season</span> <span class="op">==</span> <span class="va">s</span>, <span class="va">layer</span> <span class="op">==</span> <span class="st">"range"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rng_season</span>, col <span class="op">=</span> <span class="va">range_palette</span><span class="op">[</span><span class="va">col_season</span><span class="op">]</span>, border <span class="op">=</span> <span class="cn">NA</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span>
<span class="co"># year round</span>
<span class="kw">if</span> <span class="op">(</span><span class="va">show_yearround</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># find common area between all seasons</span>
  <span class="va">range_combined</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">range_smooth</span>, <span class="va">layer</span> <span class="op">==</span> <span class="st">"range"</span><span class="op">)</span>
  <span class="va">range_yearround</span> <span class="op">&lt;-</span> <span class="va">range_combined</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>
  <span class="va">range_combined</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">range_combined</span><span class="op">)</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">range_combined</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">range_yearround</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">range_yearround</span>, <span class="va">range_combined</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">range_yearround</span><span class="op">)</span>, 
       col <span class="op">=</span> <span class="va">range_palette</span><span class="op">[</span><span class="st">"year_round"</span><span class="op">]</span>, border <span class="op">=</span> <span class="cn">NA</span>, 
       add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span>
<span class="co"># linework</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ne_rivers</span>, col <span class="op">=</span> <span class="st">"#ffffff"</span>, lwd <span class="op">=</span> <span class="fl">0.75</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ne_state_lines</span>, col <span class="op">=</span> <span class="st">"#ffffff"</span>, lwd <span class="op">=</span> <span class="fl">1.5</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ne_country_lines</span>, col <span class="op">=</span> <span class="st">"#ffffff"</span>, lwd <span class="op">=</span> <span class="fl">2</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="co"># legend</span>
<span class="va">rng_legend</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">range_palette</span><span class="op">[</span><span class="va">legend_seasons</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">rng_legend</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">rng_legend</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html" class="external-link">str_replace_all</a></span><span class="op">(</span><span class="st">"_"</span>, <span class="st">" "</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html" class="external-link">str_to_title</a></span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"bottomleft"</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">rng_legend</span><span class="op">)</span>, fill <span class="op">=</span> <span class="va">rng_legend</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"Yellow-bellied Sapsucker Seasonal Range Map"</span>, 
      line <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, cex.main <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<p><img src="ebirdst-advanced-mapping_files/figure-html/range-map-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div id="regional-statistics" class="section level1">
<h1 class="hasAnchor">
<a href="#regional-statistics" class="anchor" aria-hidden="true"></a>Regional Statistics</h1>
<p>In addition to maps and visualizations, the eBird Status and Trends website provides a set of statistics summarizing the spatial data over regions. In the US and Canada, statistics are provided for each state and province, and throughout North America they are provided for <a href="https://nabci-us.org/resources/bird-conservation-regions-map/" class="external-link">Bird Conservation Regions (BCRs)</a>. The five regional statistics are:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Mean relative abundance:</strong> the average estimated relative abundance within the given region for a given season.</li>
<li>
<strong>Percentage of seasonal North American population:</strong> the sum of the estimated relative abundance within the selected region divided by the sum of the estimated relative abundance across North America.</li>
<li>
<strong>Percentage of region occupied:</strong> the percentage of the selected region within the range boundary of a species for a given season.</li>
<li>
<strong>Percentage of North American range in region:</strong> the fraction of a species’ total North American range that falls within the selected region.</li>
<li>
<strong>Days of occupation in region:</strong> the number of days that a species occupies the selected region, with occupation being defined as spatially covering the selected region by at least 5% based on estimated relative abundances averaged across the given season.</li>
</ol>
<p>These statistics can be <a href="https://ebird.org/science/status-and-trends/download-data" class="external-link">downloaded from the Status and Trends website</a> for all regions and species; however, there may be situations where you want to calculate them over different regions than those provided. With that in mind, this vignette will cover how to calculate a couple of these statistics: mean relative abundance and days of occupation. The remaining 3 statistics can be calculated following the same approach with minor modifications.</p>
<p>Since the example data used in this vignette is restricted to Michigan, we’ll calculate the statistics over the counties in Michigan; however, this approach can easily be extended to any set of regions. Let’s start by downloading county boundaries for Michigan.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mi_counties</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/getData.html" class="external-link">getData</a></span><span class="op">(</span><span class="st">"GADM"</span>, country <span class="op">=</span> <span class="st">"USA"</span>, level <span class="op">=</span> <span class="fl">2</span>, path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">NAME_1</span> <span class="op">==</span> <span class="st">"Michigan"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/pkg/raster/man/select.html" class="external-link">select</a></span><span class="op">(</span>county <span class="op">=</span> <span class="va">NAME_2</span>, county_code <span class="op">=</span> <span class="va">HASC_2</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/projection.html" class="external-link">projection</a></span><span class="op">(</span><span class="va">abd</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="co"># remove lakes which aren't true counties</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">county_code</span> <span class="op">!=</span> <span class="st">"US.MI.WB"</span><span class="op">)</span></code></pre></div>
<p>We’ll also use the pre-calculated, medium resolution weekly and seasonal abundance rasters to perform these calculations. The lower resolution isn’t necessary for the example dataset, but when this is extended to the full dataset it will become critical for making these calculations efficiently.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">abd_season_mr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_raster.html">load_raster</a></span><span class="op">(</span><span class="va">sp_path</span>, <span class="st">"abundance_seasonal"</span>, resolution <span class="op">=</span> <span class="st">"mr"</span><span class="op">)</span>
<span class="va">abd_mr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_raster.html">load_raster</a></span><span class="op">(</span><span class="va">sp_path</span>, <span class="st">"abundance"</span>, resolution <span class="op">=</span> <span class="st">"mr"</span><span class="op">)</span></code></pre></div>
<div id="mean-relative-abundance" class="section level2">
<h2 class="hasAnchor">
<a href="#mean-relative-abundance" class="anchor" aria-hidden="true"></a>Mean Relative Abundance</h2>
<p>Mean relative abundance is the easiest statistics to calculate: we simply average all the raster cells within each region polygon.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">abd_mean_region</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">abd_season_mr</span>, <span class="va">mi_counties</span>, 
                                   fun <span class="op">=</span> <span class="va">mean</span>, df <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="co"># assign season names</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">abd_season_mr</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="co"># attach county attributes</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>county_code <span class="op">=</span> <span class="va">mi_counties</span><span class="op">$</span><span class="va">county_code</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/pkg/raster/man/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">id</span><span class="op">)</span>
<span class="co"># transpose to one season per row</span>
<span class="va">abd_mean_region</span> <span class="op">&lt;-</span> <span class="va">abd_mean_region</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html" class="external-link">gather</a></span><span class="op">(</span><span class="va">season</span>, <span class="va">mean_abundance</span>, <span class="op">-</span><span class="va">county_code</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">abd_mean_region</span><span class="op">)</span>
<span class="co">#&gt;   county_code   season mean_abundance</span>
<span class="co">#&gt; 1    US.MI.AC breeding             NA</span>
<span class="co">#&gt; 2    US.MI.AG breeding   0.6738384577</span>
<span class="co">#&gt; 3    US.MI.AL breeding   0.0002190809</span>
<span class="co">#&gt; 4    US.MI.AP breeding             NA</span>
<span class="co">#&gt; 5    US.MI.AN breeding   0.5538232129</span>
<span class="co">#&gt; 6    US.MI.AR breeding   0.2715548898</span></code></pre></div>
<p>Let’s make a quick map comparing the breeding and non-breeding mean relative abundance within counties in Michigan.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># join back to county boundaries</span>
<span class="va">abd_mean_proj</span> <span class="op">&lt;-</span> <span class="va">abd_mean_region</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">mi_counties</span>, <span class="va">.</span>, by <span class="op">=</span> <span class="st">"county_code"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="co"># transform to mollweide for plotting</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="va">proj</span><span class="op">)</span>

<span class="co"># plot</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">abd_mean_proj</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">season</span> <span class="op"><a href="https://rdrr.io/pkg/raster/man/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"breeding"</span>, <span class="st">"nonbreeding"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="co"># abundance data</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">mean_abundance</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"sqrt"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html" class="external-link">guide_colorbar</a></span><span class="op">(</span>title.position <span class="op">=</span> <span class="st">"top"</span>, barwidth <span class="op">=</span> <span class="fl">15</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">season</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Seasonal mean relative abundance in MI counties"</span>,
       fill <span class="op">=</span> <span class="st">"Relative abundance"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></code></pre></div>
<p><img src="ebirdst-advanced-mapping_files/figure-html/mean-rel-abd-map-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div id="days-of-occupation" class="section level2">
<h2 class="hasAnchor">
<a href="#days-of-occupation" class="anchor" aria-hidden="true"></a>Days of Occupation</h2>
<p>Days of occupation is the most challenging statistic to calculate because it involves several steps. First, for each week, we need to determine if a region (i.e. a county) is “occupied”. We define occupied as at least 5% of the cells within the region having a non-zero abundance.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">threshold_occupied</span> <span class="op">&lt;-</span> <span class="fl">0.05</span>

<span class="co"># weekly percent occupied</span>
<span class="va">calc_week_occupied</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">wk</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">abd_mr</span><span class="op">[[</span><span class="va">wk</span><span class="op">]</span><span class="op">]</span>, <span class="va">mi_counties</span>, 
                  fun <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fl">0</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">}</span>, 
                  df <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"pct_occupied"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
    <span class="co"># assign week, season, and county</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">transmute</a></span><span class="op">(</span>week_date <span class="op">=</span> <span class="va">weeks</span><span class="op">[</span><span class="va">wk</span><span class="op">]</span>,
              season <span class="op">=</span> <span class="va">weeks_season</span><span class="op">[</span><span class="va">wk</span><span class="op">]</span>,
              county_code <span class="op">=</span> <span class="va">mi_counties</span><span class="op">$</span><span class="va">county_code</span>,
              pct_occupied <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/coalesce.html" class="external-link">coalesce</a></span><span class="op">(</span><span class="va">pct_occupied</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="co"># process weeks independently otherwise we'll run into memory issues</span>
<span class="va">week_occupied</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/nlayers.html" class="external-link">nlayers</a></span><span class="op">(</span><span class="va">abd_mr</span><span class="op">)</span><span class="op">)</span>, <span class="va">calc_week_occupied</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>occupied <span class="op">=</span> <span class="op">(</span><span class="va">pct_occupied</span> <span class="op">&gt;</span> <span class="va">threshold_occupied</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Next, we tally up the number of weeks each region is occupied, then convert to days by multiplying by 7.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">days_occupation</span> <span class="op">&lt;-</span> <span class="va">week_occupied</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">county_code</span>, <span class="va">season</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/tidyverse.html" class="external-link">summarise</a></span><span class="op">(</span>weeks_occ <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">occupied</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>days_occ <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">7</span> <span class="op">*</span> <span class="va">weeks_occ</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/pkg/raster/man/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">county_code</span>, <span class="va">season</span>, <span class="va">days_occ</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">days_occupation</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 6 × 3</span>
<span class="co">#&gt;   county_code season                 days_occ</span>
<span class="co">#&gt;   &lt;chr&gt;       &lt;chr&gt;                     &lt;dbl&gt;</span>
<span class="co">#&gt; 1 US.MI.AC    breeding                    112</span>
<span class="co">#&gt; 2 US.MI.AC    nonbreeding                   0</span>
<span class="co">#&gt; 3 US.MI.AC    postbreeding_migration       35</span>
<span class="co">#&gt; 4 US.MI.AC    prebreeding_migration        49</span>
<span class="co">#&gt; 5 US.MI.AG    breeding                    112</span>
<span class="co">#&gt; 6 US.MI.AG    nonbreeding                   0</span></code></pre></div>
<p>Finally, let’s produce a map comparing days occupation in the breeding and non-breeding season.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># join back to county boundaries</span>
<span class="va">days_occ_proj</span> <span class="op">&lt;-</span> <span class="va">days_occupation</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">mi_counties</span>, <span class="va">.</span>, by <span class="op">=</span> <span class="st">"county_code"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="co"># transform to mollweide for plotting</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="va">proj</span><span class="op">)</span>

<span class="co"># plot</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">days_occ_proj</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">season</span> <span class="op"><a href="https://rdrr.io/pkg/raster/man/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"breeding"</span>, <span class="st">"nonbreeding"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="co"># abundance data</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">days_occ</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_colourbar.html" class="external-link">guide_colorbar</a></span><span class="op">(</span>title.position <span class="op">=</span> <span class="st">"top"</span>, barwidth <span class="op">=</span> <span class="fl">15</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">season</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Seasonal days of occupation in MI counties"</span>,
       fill <span class="op">=</span> <span class="st">"Days of occupation"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></code></pre></div>
<p><img src="ebirdst-advanced-mapping_files/figure-html/day-occ-map-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="http://strimas.com" class="external-link external-link">Matthew Strimas-Mackey</a>, Shawn Ligocki, <a href="http://twitter.com/tom_auer" class="external-link external-link">Tom Auer</a>, Daniel Fink.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link external-link">pkgdown</a> 1.6.1.9001.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
